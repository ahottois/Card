document.addEventListener("DOMContentLoaded",function(){let e=document.getElementById("cardsContainer"),t=document.getElementById("cardForm"),a=document.getElementById("cardModal"),n=document.getElementById("viewCardModal"),l=document.getElementById("viewCardContent"),i=document.getElementById("addCardButton"),r=document.querySelectorAll(".close-modal"),c=document.getElementById("gallerySelector"),d=document.getElementById("imageGallery"),s=document.getElementById("cardColor"),o=document.querySelector(".color-preview"),m=document.getElementById("tagsList"),g=["info"],p=[],u=null,h=[];function f(e){let t=C(e,30),a=A(e,30);o.style.background=`linear-gradient(var(--rotate), ${t}, ${e} 43%, ${a})`}function E(e){let t=!1;e.forEach(e=>{if(!g.includes(e)){g.push(e),t=!0;let a=document.createElement("span");a.className="tag",a.setAttribute("data-tag",e),a.textContent=e,a.addEventListener("click",function(){v(e)}),m.appendChild(a)}}),t&&(document.querySelectorAll(".tag").forEach(e=>{e.classList.remove("active"),"all"===e.getAttribute("data-tag")&&e.classList.add("active")}),document.querySelectorAll(".card:not(.add-card)").forEach(e=>{e.classList.remove("hidden")}))}function v(e){document.querySelectorAll(".tag").forEach(t=>{t.classList.remove("active"),t.getAttribute("data-tag")===e&&t.classList.add("active")});let t=document.querySelectorAll(".card:not(.add-card)");"all"===e?t.forEach(e=>{e.classList.remove("hidden")}):t.forEach(t=>{let a=t.getAttribute("data-tags")?t.getAttribute("data-tags").split(","):[];a.includes(e)?t.classList.remove("hidden"):t.classList.add("hidden")})}function y(){u=null,document.querySelectorAll(".image-checkbox-input").forEach(e=>{e.checked=!1}),document.querySelectorAll(".image-checkbox").forEach(e=>{e.classList.remove("selected")})}function $(t,a,n,l,r,c){let d=document.createElement("div");d.className="card",d.setAttribute("data-color",r),d.setAttribute("data-tags",l.join(",")),d.setAttribute("data-title",t),d.setAttribute("data-explanation",a),d.setAttribute("data-content",n),d.setAttribute("data-image",c||"");let s=document.createElement("div");s.className="card-content";let o=document.createElement("h2");if(o.textContent=t,s.appendChild(o),c){let m=document.createElement("div");m.className="card-img";let g=document.createElement("img");g.src=c,g.alt=t,m.appendChild(g),s.appendChild(m)}let p=document.createElement("p");if(p.className="card-explanation",p.textContent=a,s.appendChild(p),l.length>0){let u=document.createElement("div");u.className="card-tags",l.forEach(e=>{let t=document.createElement("span");t.className="card-tag",t.textContent=e,u.appendChild(t)}),s.appendChild(u)}d.appendChild(s),x(d,r),d.addEventListener("click",function(){b(this)}),e.insertBefore(d,i)}function b(e){let t=e.getAttribute("data-title"),a=e.getAttribute("data-explanation"),i=e.getAttribute("data-content"),r=e.getAttribute("data-image"),c=e.getAttribute("data-tags")?e.getAttribute("data-tags").split(","):[],d=`<h2>${t}</h2>`;r&&(d+=`
                <div class="view-card-img">
                    <img src="${r}" alt="${t}">
                </div>
            `),d+=`<p class="view-card-explanation">${a}</p>`,i&&(d+=`<div class="view-card-content">${i}</div>`),c.length>0&&(d+='<div class="view-card-tags">',c.forEach(e=>{d+=`<span class="view-card-tag">${e}</span>`}),d+="</div>"),l.innerHTML=d,n.style.display="block"}function x(t,a){let n=C(a,30),l=A(a,30);t.style.setProperty("--rotate-color-1",a),t.style.setProperty("--card-gradient",`linear-gradient(var(--rotate), ${n}, ${a} 43%, ${l})`),Array.from(e.children).indexOf(t);let i=`card-${Date.now()}-${Math.floor(1e3*Math.random())}`;t.id=i;let r=document.createElement("style");r.textContent=`
            #${i}::before {
                background-image: linear-gradient(var(--rotate), ${n}, ${a} 43%, ${l}) !important;
            }
            #${i}::after {
                background-image: linear-gradient(var(--rotate), ${n}, ${a} 43%, ${l}) !important;
            }
        `,document.head.appendChild(r)}function C(e,t){let a=parseInt(e.replace("#",""),16),n=Math.round(2.55*t),l=(a>>16)+n,i=(a>>8&255)+n,r=(255&a)+n;return"#"+(16777216+(l<255?l<1?0:l:255)*65536+(i<255?i<1?0:i:255)*256+(r<255?r<1?0:r:255)).toString(16).slice(1)}function A(e,t){let a=parseInt(e.replace("#",""),16),n=Math.round(2.55*t),l=(a>>16)-n,i=(a>>8&255)-n,r=(255&a)-n;return"#"+(16777216+(l>0?l>255?255:l:0)*65536+(i>0?i>255?255:i:0)*256+(r>0?r>255?255:r:0)).toString(16).slice(1)}function L(){localStorage.setItem("animatedCards",JSON.stringify(h))}function k(){let e=JSON.stringify(h,null,2),t=new Blob([e],{type:"application/json"}),a=URL.createObjectURL(t),n=document.createElement("a");n.href=a,n.download="mes-cartes-animees.json",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(a)}(function e(){let t=[{name:"paysage",path:"/img/paysage.jpg"},{name:"montagne",path:"/img/montagne.jpg"},{name:"plage",path:"/img/plage.jpg"},{name:"for\xeat",path:"/img/foret.jpg"},{name:"ville",path:"/img/ville.jpg"},{name:"mer",path:"/img/mer.jpg"},{name:"ciel",path:"/img/ciel.jpg"},{name:"rivi\xe8re",path:"/img/riviere.jpg"}];p=t,t.forEach(e=>{(function e(t){let a=document.createElement("div");a.className="image-checkbox";let n=document.createElement("label");n.className="image-checkbox-label";let l=document.createElement("input");l.type="checkbox",l.name="selectedImage",l.value=t.path,l.className="image-checkbox-input";let i=document.createElement("div");i.className="image-thumbnail";let r=document.createElement("img");r.src=t.path,r.alt=t.name;let c=document.createElement("div");c.className="image-name",c.textContent=t.name,i.appendChild(r),i.appendChild(c),n.appendChild(l),n.appendChild(i),a.appendChild(n),l.addEventListener("change",function(){document.querySelectorAll(".image-checkbox-input").forEach(e=>{e!==this&&(e.checked=!1)}),document.querySelectorAll(".image-checkbox").forEach(e=>{e.classList.remove("selected")}),this.checked?(a.classList.add("selected"),u=t):u=null}),d.appendChild(a)})(e)})})(),s.addEventListener("input",function(){f(this.value)}),f(s.value),i.addEventListener("click",function(){a.style.display="block"}),r.forEach(e=>{e.addEventListener("click",function(){a.style.display="none",n.style.display="none"})}),window.addEventListener("click",function(e){e.target===a&&(a.style.display="none"),e.target===n&&(n.style.display="none")}),document.getElementById("useImage").addEventListener("change",function(){this.checked?c.style.display="block":(c.style.display="none",y())}),t.addEventListener("submit",function(e){e.preventDefault();let n=document.getElementById("cardTitle").value,l=document.getElementById("cardExplanation").value,i=document.getElementById("cardContent").value,r=document.getElementById("cardTags").value,d=document.getElementById("cardColor").value,s=document.getElementById("useImage").checked,o=r.split(",").map(e=>e.trim().toLowerCase()).filter(e=>e.length>0);E(o);let m="";s&&u&&(m=u.path);let g={title:n,explanation:l,content:i,tags:o,color:d,imageSrc:m};h.push(g),$(n,l,i,o,d,m),a.style.display="none",t.reset(),c.style.display="none",y(),f("#3c67e3"),L()}),document.querySelector('.tag[data-tag="all"]').addEventListener("click",function(){v("all")}),!function e(){let t=document.createElement("div");t.className="import-export-container";let a=document.createElement("button");a.className="import-export-btn export-btn",a.textContent="Exporter mes cartes",a.addEventListener("click",k);let n=document.createElement("div");n.className="import-container";let l=document.createElement("label");l.className="import-label",l.textContent="Importer des cartes",l.htmlFor="importFile";let i=document.createElement("input");i.type="file",i.id="importFile",i.accept=".json",i.style.display="none",i.addEventListener("change",function(e){e.target.files.length>0&&function e(t){let a=new FileReader;a.onload=function(e){try{let t=JSON.parse(e.target.result);if(Array.isArray(t)){let a=confirm("Voulez-vous fusionner ces cartes avec vos cartes existantes? Cliquez sur Annuler pour remplacer toutes vos cartes.");if(!a){let n=document.querySelectorAll(".card:not(.add-card):not(.info-card)");n.forEach(e=>e.remove()),h=[]}t.forEach(e=>{e.title&&e.explanation&&(h.push(e),e.tags&&e.tags.length>0&&E(e.tags),$(e.title,e.explanation,e.content||"",e.tags||[],e.color||"#3c67e3",e.imageSrc||""))}),L(),alert("Importation r\xe9ussie !")}else alert("Format de fichier invalide. Veuillez s\xe9lectionner un fichier JSON valide.")}catch(l){console.error("Erreur lors de l'importation :",l),alert("Erreur lors de l'importation du fichier.")}},a.readAsText(t)}(e.target.files[0])}),n.appendChild(l),n.appendChild(i),t.appendChild(a),t.appendChild(n);let r=document.querySelector(".tags-filter");r.parentNode.insertBefore(t,r.nextSibling)}(),function e(){let t=localStorage.getItem("animatedCards");t&&((h=JSON.parse(t)).forEach(e=>{e.tags&&e.tags.length>0&&E(e.tags)}),h.forEach(e=>{$(e.title,e.explanation,e.content,e.tags,e.color,e.imageSrc)}))}(),function e(){let t=document.querySelectorAll(".card:not(.add-card)");t.forEach(e=>{let t=e.getAttribute("data-color");if(t&&x(e,t),!e.classList.contains("add-card")&&!e.classList.contains("info-card")){let a={title:e.getAttribute("data-title"),explanation:e.getAttribute("data-explanation"),content:e.getAttribute("data-content"),tags:e.getAttribute("data-tags")?e.getAttribute("data-tags").split(","):[],color:e.getAttribute("data-color"),imageSrc:e.getAttribute("data-image")};h.push(a),e.addEventListener("click",function(){b(this)})}e.classList.contains("info-card")&&e.addEventListener("click",function(){this.style.transform="scale(1.05)",setTimeout(()=>{this.style.transform=""},300)})})}()});